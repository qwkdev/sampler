<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Sampler</title>

	<style>
		:root {
			--bg: #000;
			--shadow: #00000177;
			--fg: #222223;
			--fg2: #333334;
			--fg3: #555556;
			--fg4: #777778;
			--text: #fff;
			--selection: #fff7;
			--brand: #30f;
			--brandt: #60f5;

			--u: 1.2vw;
		}

		body {
			margin: 0;
			background: var(--bg);

			overflow: hidden;
		}
		#controller {
			#grid {
				position: relative;
				width: 100vw;
				/* height: 100vh; */
				display: grid;
				grid-template-columns: repeat(8, 1fr);
				gap: 1vw;

				.pad {
					--clr: var(--fg);
					width: 100%;
					height: auto;
					aspect-ratio: 1/1;
					background: var(--clr);

					--cut: 1.5vw;
				}
				#pad54 { clip-path: polygon(0 0, 100% 0, 100% calc(100% - var(--cut)), calc(100% - var(--cut)) 100%, 0 100%); }
				#pad55 { clip-path: polygon(0 0, 100% 0, 100% 100%, var(--cut) 100%, 0 calc(100% - var(--cut))); }
				#pad44 { clip-path: polygon(0 0, calc(100% - var(--cut)) 0, 100% var(--cut), 100% 100%, 0 100%); }
				#pad45 { clip-path: polygon(var(--cut) 0, 100% 0, 100% 100%, 0 100%, 0 var(--cut)); }
			}
		}

		#load {
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;

			background: var(--bg);
			z-index: 100;
			
			&hidden {
				display: none;
			}
			p {
				position: absolute;
				top: 50%;
				left: 50%;
				transform: translate(-50%, -50%);

				color: var(--text);
			}
		}
		
		input[type='number'] {
			-moz-appearance: textfield;
			appearance: textfield;
		}
		input::-webkit-outer-spin-button,
		input::-webkit-inner-spin-button {
			-webkit-appearance: none;
		}

		dialog {
			margin: 0;
			padding: 0;
			border: none;
			max-width: 100vw;
			max-height: 100vh;

			position: absolute;
			top: 0;
			left: 0;

			width: 100vw;
			height: 100vh;

			background: var(--shadow);
		}
		dialog .modal {
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);

			width: calc(60 * var(--u));
			height: max-content;
			max-height: 80vh;
			box-sizing: border-box;

			padding: calc(1.5 * var(--u));
			background: var(--bg);
			border-radius: calc(1 * var(--u));

			display: flex;
			flex-direction: column;
			align-items: center;

			h1, p {
				color: var(--text);
				font-family: Arial;
			}
			h1 {
				margin: calc(1 * var(--u)) 0;
				font-size: calc(2.5 * var(--u));
			}
			p {
				margin: calc(1 * var(--u)) 0;
				font-size: calc(1 * var(--u));
			}
			#waveform {
				width: 80%;
				margin: calc(1.5 * var(--u)) 0;

				::part(region) {
					color: var(--text);
				}
			}

			#clr-picker {
				display: flex;
				margin-top: calc(1.5 * var(--u));

				#presets {
					display: grid;
					grid-template-columns: repeat(16, calc(2 * var(--u)));

					.colour {
						background: var(--clr);

						border: none;
						width: 100%;
						aspect-ratio: 1/1;
					}
				}
				#chosen {
					width: calc(12 * var(--u));
					height: calc(12 * var(--u));
					margin: calc(2 * var(--u));
					background: var(--clr);
					border-radius: calc(.5 * var(--u));
				}
			}
			#rgb {
				display: flex;
				gap: calc(1 * var(--u));
				margin-top: calc(1.5 * var(--u));
				justify-content: center;

				input, #clr-set {
					font-family: Arial;
					width: calc(8 * var(--u));
					font-size: calc(2 * var(--u));
					border-radius: calc(.5 * var(--u));
					text-align: center;

					background: var(--fg);
					border: 1px solid var(--fg3);
					color: var(--text);

					&:focus {
						outline: none;
						border-color: var(--brand);
					}
					&::selection {
						background: var(--selection);
					}
				}
				#clr-set {
					cursor: pointer;
					border-color: var(--brand);
					background: var(--brand);
				}
			}

			#save-pad {
				margin: calc(2 * var(--u)) 0;
				padding: calc(1 * var(--u)) calc(2 * var(--u));
				font-size: calc(2.5 * var(--u));
				border-radius: calc(.5 * var(--u));
				text-align: center;
				
				background: var(--brand);
				border: 1px solid var(--brand);
				color: var(--text);
				font-family: Arial;
				
				&:focus {
					outline: none;
				}
				&::selection {
					background: var(--selection);
				}

				cursor: pointer;
			}
		}

		#zoom-slider {
			appearance: none;
			-webkit-appearance: none;
			background: transparent;
			cursor: pointer;
			width: 80%;
			--fill: 0%;

			&::-webkit-slider-runnable-track, &::-moz-range-track {
				background: linear-gradient(to right, var(--fg4) var(--fill), var(--fg2) var(--fill)) !important;
				border-radius: calc(1 * var(--u));
				height: calc(1 * var(--u));
			}
			&::-moz-range-thumb {
				border: none;
				border-radius: 50%;
				background-color: var(--text);
				width: calc(2 * var(--u));
				height: calc(2 * var(--u));
			}
			&:focus {
				outline: none;
			}
		}
	</style>
</head>
<body>
	<div id="controller">
		<!-- <div id="top">
			<div class=""></div>
		</div>
		<div id="side">
			<div class=""></div>
		</div> -->
		<div id="grid">
			<div class="pad" id="pad81"></div>
			<div class="pad" id="pad82"></div>
			<div class="pad" id="pad83"></div>
			<div class="pad" id="pad84"></div>
			<div class="pad" id="pad85"></div>
			<div class="pad" id="pad86"></div>
			<div class="pad" id="pad87"></div>
			<div class="pad" id="pad88"></div>
			<div class="pad" id="pad71"></div>
			<div class="pad" id="pad72"></div>
			<div class="pad" id="pad73"></div>
			<div class="pad" id="pad74"></div>
			<div class="pad" id="pad75"></div>
			<div class="pad" id="pad76"></div>
			<div class="pad" id="pad77"></div>
			<div class="pad" id="pad78"></div>
			<div class="pad" id="pad61"></div>
			<div class="pad" id="pad62"></div>
			<div class="pad" id="pad63"></div>
			<div class="pad" id="pad64"></div>
			<div class="pad" id="pad65"></div>
			<div class="pad" id="pad66"></div>
			<div class="pad" id="pad67"></div>
			<div class="pad" id="pad68"></div>
			<div class="pad" id="pad51"></div>
			<div class="pad" id="pad52"></div>
			<div class="pad" id="pad53"></div>
			<div class="pad" id="pad54"></div>
			<div class="pad" id="pad55"></div>
			<div class="pad" id="pad56"></div>
			<div class="pad" id="pad57"></div>
			<div class="pad" id="pad58"></div>
			<div class="pad" id="pad41"></div>
			<div class="pad" id="pad42"></div>
			<div class="pad" id="pad43"></div>
			<div class="pad" id="pad44"></div>
			<div class="pad" id="pad45"></div>
			<div class="pad" id="pad46"></div>
			<div class="pad" id="pad47"></div>
			<div class="pad" id="pad48"></div>
			<div class="pad" id="pad31"></div>
			<div class="pad" id="pad32"></div>
			<div class="pad" id="pad33"></div>
			<div class="pad" id="pad34"></div>
			<div class="pad" id="pad35"></div>
			<div class="pad" id="pad36"></div>
			<div class="pad" id="pad37"></div>
			<div class="pad" id="pad38"></div>
			<div class="pad" id="pad21"></div>
			<div class="pad" id="pad22"></div>
			<div class="pad" id="pad23"></div>
			<div class="pad" id="pad24"></div>
			<div class="pad" id="pad25"></div>
			<div class="pad" id="pad26"></div>
			<div class="pad" id="pad27"></div>
			<div class="pad" id="pad28"></div>
			<div class="pad" id="pad11"></div>
			<div class="pad" id="pad12"></div>
			<div class="pad" id="pad13"></div>
			<div class="pad" id="pad14"></div>
			<div class="pad" id="pad15"></div>
			<div class="pad" id="pad16"></div>
			<div class="pad" id="pad17"></div>
			<div class="pad" id="pad18"></div>
		</div>
	</div>

	<div id="load" onclick="start()">
		<p>Click</p>
	</div>

	<dialog id="edit-pad-modal">
		<div class="modal">
			<h1>Edit Pad</h1>

			<div id="waveform"></div>
			<input id="zoom-slider" type="range" min="0" max="2000" value="0" />
		
			<div id="pad-clr" data-id="" data-rgb="">
				<div id="clr-picker">
					<div id="presets">
<button class="colour" data-value="0" style="--clr: #616161"></button>
<button class="colour" data-value="4" style="--clr: #ffb3b3"></button>
<button class="colour" data-value="8" style="--clr: #fff3d5"></button>
<button class="colour" data-value="12" style="--clr: #ffeea1"></button>
<button class="colour" data-value="16" style="--clr: #ddffa1"></button>
<button class="colour" data-value="20" style="--clr: #c2ffb3"></button>
<button class="colour" data-value="24" style="--clr: #c2ffc2"></button>
<button class="colour" data-value="28" style="--clr: #c2ffcc"></button>
<button class="colour" data-value="32" style="--clr: #c2fff3"></button>
<button class="colour" data-value="36" style="--clr: #c2f3ff"></button>
<button class="colour" data-value="40" style="--clr: #c2ddff"></button>
<button class="colour" data-value="44" style="--clr: #a18cff"></button>
<button class="colour" data-value="48" style="--clr: #ccb3ff"></button>
<button class="colour" data-value="52" style="--clr: #ffb3ff"></button>
<button class="colour" data-value="56" style="--clr: #ffb3d5"></button>
<button class="colour" data-value="60" style="--clr: #ff7661"></button>
<button class="colour" data-value="1" style="--clr: #b3b3b3"></button>
<button class="colour" data-value="5" style="--clr: #ff6161"></button>
<button class="colour" data-value="9" style="--clr: #ffb361"></button>
<button class="colour" data-value="13" style="--clr: #ffff61"></button>
<button class="colour" data-value="17" style="--clr: #c2ff61"></button>
<button class="colour" data-value="21" style="--clr: #61ff61"></button>
<button class="colour" data-value="25" style="--clr: #61ff8c"></button>
<button class="colour" data-value="29" style="--clr: #61ffcc"></button>
<button class="colour" data-value="33" style="--clr: #61ffe9"></button>
<button class="colour" data-value="37" style="--clr: #61eeff"></button>
<button class="colour" data-value="41" style="--clr: #61c7ff"></button>
<button class="colour" data-value="45" style="--clr: #6161ff"></button>
<button class="colour" data-value="49" style="--clr: #a161ff"></button>
<button class="colour" data-value="53" style="--clr: #ff61ff"></button>
<button class="colour" data-value="57" style="--clr: #ff61c2"></button>
<button class="colour" data-value="61" style="--clr: #e9b361"></button>
<button class="colour" data-value="2" style="--clr: #dddddd"></button>
<button class="colour" data-value="6" style="--clr: #dd6161"></button>
<button class="colour" data-value="10" style="--clr: #dd8c61"></button>
<button class="colour" data-value="14" style="--clr: #dddd61"></button>
<button class="colour" data-value="18" style="--clr: #a1dd61"></button>
<button class="colour" data-value="22" style="--clr: #61dd61"></button>
<button class="colour" data-value="26" style="--clr: #61dd76"></button>
<button class="colour" data-value="30" style="--clr: #61dda1"></button>
<button class="colour" data-value="34" style="--clr: #61ddc2"></button>
<button class="colour" data-value="38" style="--clr: #61c7dd"></button>
<button class="colour" data-value="42" style="--clr: #61a1dd"></button>
<button class="colour" data-value="46" style="--clr: #6161dd"></button>
<button class="colour" data-value="50" style="--clr: #8161dd"></button>
<button class="colour" data-value="54" style="--clr: #dd61dd"></button>
<button class="colour" data-value="58" style="--clr: #dd61a1"></button>
<button class="colour" data-value="62" style="--clr: #ddc261"></button>
<button class="colour" data-value="3" style="--clr: #ffffff"></button>
<button class="colour" data-value="7" style="--clr: #b36161"></button>
<button class="colour" data-value="11" style="--clr: #b37661"></button>
<button class="colour" data-value="15" style="--clr: #b3b361"></button>
<button class="colour" data-value="19" style="--clr: #81b361"></button>
<button class="colour" data-value="23" style="--clr: #61b361"></button>
<button class="colour" data-value="27" style="--clr: #61b36b"></button>
<button class="colour" data-value="31" style="--clr: #61b381"></button>
<button class="colour" data-value="35" style="--clr: #61b396"></button>
<button class="colour" data-value="39" style="--clr: #61a1b3"></button>
<button class="colour" data-value="43" style="--clr: #6181b3"></button>
<button class="colour" data-value="47" style="--clr: #6161b3"></button>
<button class="colour" data-value="51" style="--clr: #7661b3"></button>
<button class="colour" data-value="55" style="--clr: #b361b3"></button>
<button class="colour" data-value="59" style="--clr: #b3618c"></button>
<button class="colour" data-value="63" style="--clr: #a1a161"></button>
<button class="colour" data-value="23" style="--clr: #61b361"></button>
<button class="colour" data-value="68" style="--clr: #61b3b3"></button>
<button class="colour" data-value="5" style="--clr: #ff6161"></button>
<button class="colour" data-value="76" style="--clr: #76dd61"></button>
<button class="colour" data-value="80" style="--clr: #8c61ff"></button>
<button class="colour" data-value="84" style="--clr: #ffa161"></button>
<button class="colour" data-value="88" style="--clr: #b3ffa1"></button>
<button class="colour" data-value="92" style="--clr: #a1c2f6"></button>
<button class="colour" data-value="96" style="--clr: #ffc261"></button>
<button class="colour" data-value="100" style="--clr: #b3a161"></button>
<button class="colour" data-value="104" style="--clr: #818ccc"></button>
<button class="colour" data-value="108" style="--clr: #f9ba76"></button>
<button class="colour" data-value="103" style="--clr: #8181a1"></button>
<button class="colour" data-value="116" style="--clr: #e4d5ff"></button>
<button class="colour" data-value="120" style="--clr: #e96161"></button>
<button class="colour" data-value="97" style="--clr: #f3ee61"></button>
<button class="colour" data-value="65" style="--clr: #61b38c"></button>
<button class="colour" data-value="69" style="--clr: #8c61f3"></button>
<button class="colour" data-value="73" style="--clr: #f3ffa1"></button>
<button class="colour" data-value="29" style="--clr: #61ffcc"></button>
<button class="colour" data-value="81" style="--clr: #cc61fc"></button>
<button class="colour" data-value="85" style="--clr: #ddf961"></button>
<button class="colour" data-value="89" style="--clr: #ccfcd5"></button>
<button class="colour" data-value="93" style="--clr: #d5c2f9"></button>
<button class="colour" data-value="97" style="--clr: #f3ee61"></button>
<button class="colour" data-value="101" style="--clr: #61ba76"></button>
<button class="colour" data-value="105" style="--clr: #ccaa81"></button>
<button class="colour" data-value="109" style="--clr: #fff38c"></button>
<button class="colour" data-value="113" style="--clr: #f9f9d5"></button>
<button class="colour" data-value="1" style="--clr: #b3b3b3"></button>
<button class="colour" data-value="121" style="--clr: #aa6161"></button>
<button class="colour" data-value="100" style="--clr: #b3a161"></button>
<button class="colour" data-value="66" style="--clr: #618cd5"></button>
<button class="colour" data-value="70" style="--clr: #ccb3c2"></button>
<button class="colour" data-value="74" style="--clr: #eefc61"></button>
<button class="colour" data-value="78" style="--clr: #61e9ff"></button>
<button class="colour" data-value="82" style="--clr: #ee8cdd"></button>
<button class="colour" data-value="86" style="--clr: #d5ff8c"></button>
<button class="colour" data-value="90" style="--clr: #b3fff6"></button>
<button class="colour" data-value="94" style="--clr: #f98cff"></button>
<button class="colour" data-value="98" style="--clr: #e4ff61"></button>
<button class="colour" data-value="102" style="--clr: #76c28c"></button>
<button class="colour" data-value="6" style="--clr: #dd6161"></button>
<button class="colour" data-value="110" style="--clr: #e9f9a1"></button>
<button class="colour" data-value="114" style="--clr: #ddfce4"></button>
<button class="colour" data-value="118" style="--clr: #d5d5d5"></button>
<button class="colour" data-value="122" style="--clr: #81f661"></button>
<button class="colour" data-value="126" style="--clr: #eec261"></button>
<button class="colour" data-value="45" style="--clr: #6161ff"></button>
<button class="colour" data-value="71" style="--clr: #8c7681"></button>
<button class="colour" data-value="75" style="--clr: #ccff61"></button>
<button class="colour" data-value="79" style="--clr: #61a1ff"></button>
<button class="colour" data-value="83" style="--clr: #a17661"></button>
<button class="colour" data-value="21" style="--clr: #61ff61"></button>
<button class="colour" data-value="91" style="--clr: #cce4ff"></button>
<button class="colour" data-value="95" style="--clr: #ff61cc"></button>
<button class="colour" data-value="99" style="--clr: #ddcc61"></button>
<button class="colour" data-value="103" style="--clr: #8181a1"></button>
<button class="colour" data-value="107" style="--clr: #f9b3a1"></button>
<button class="colour" data-value="111" style="--clr: #d5ee76"></button>
<button class="colour" data-value="115" style="--clr: #e9e9ff"></button>
<button class="colour" data-value="119" style="--clr: #f9ffff"></button>
<button class="colour" data-value="23" style="--clr: #61b361"></button>
<button class="colour" data-value="127" style="--clr: #c27661"></button>
					</div>
					<div id="chosen"></div>
				</div>
				<div id="rgb">
					<input type="number" min="0" max="255" id="clr-r">
					<input type="number" min="0" max="255" id="clr-g">
					<input type="number" min="0" max="255" id="clr-b">
					<button id="clr-set" onclick="setRGBColour()">Set</button>
				</div>
			</div>

			<button id="save-pad" onclick="savePad()">Save</button>
		</div>
	</dialog>

	<script src="https://unpkg.com/wavesurfer.js@7"></script>
	<script src="https://unpkg.com/wavesurfer.js@7/dist/plugins/regions.min.js"></script>
	<script>
		const DEFAULTS = {
			off: 0,
			on: 3,
			_on: '#fff'
		};

		// Samples object, with urls and loaded objects

		const midiCodes = {
			logo: 99,
			top: Array.from({ length: 8 }, (_, i) => 91+i),
			side: Array.from({ length: 8 }, (_, i) => 89-(i*10)),
			grid: Array.from({ length: 8 }, (_, i) => Array.from({ length: 8 }, (_, j) => 81-(10*i)+j))
		};

		function toPad(note) {
			if (note == 99) return { type: 'logo' }
			if (91 <= note && note <= 98) return { type: 'top', pos: note - 91 }
			if ((note - 9) % 10 == 0) return { type: 'side', pos: (89-note)/10 }
			return { type: 'grid', x: (note % 10) - 1, y: 8 - Math.floor(note/10) }
		}

		function setLEDs(lOut, spec) {
			if (spec.length == 1 && spec[0][1] !== 3) {
				lOut.send([144, spec[0][0], spec[0][2]]);
				return;
			}
			if (spec.length > 81) throw Error('Max 81 colourspecs at a time');

			let data = [];
			spec.forEach(info => {
				data.push(
					info[1],
					info[0],
					...(info[1] === 3 ? ([info[2], info[3], info[4]].map(n => Math.floor(parseFloat(n)/2))) : [info[2]])
				);
			})
			lOut.send([240, 0, 32, 41, 2, 12, 3, ...data, 247]);
		}
		function setAllLEDs(lOut, spec) {
			setLEDs(lOut, Array.from({ length: 81 }, (_, i) => [
				Math.floor(i / 9) * 10 + 11 + (i % 9), ...spec
			]));
		}

		function sendText(lOut, text, palatte=null, rgb=null, speed=12, loop=false) {
			let textData = [];
			Array.from(text).forEach(c => {
				const ascii = c.charCodeAt();
				if (ascii < 128) textData.push(ascii);
				else throw Error('Invalid non-ascii character.');
			});

			lOut.send([
				240, 0, 32, 41, 2, 12, 7,
				loop ? 1 : 0,
				speed,
				palatte !== null ? 0 : 1,
				...(palatte !== null ? [palatte] : [rgb[0], rgb[1], rgb[2]]),
				...textData,
				247
			])
		}
		function stopText(lOut) {
			lOut.send([240, 0, 32, 41, 2, 12, 7, 247]);
		}

		let launchpadInput;
		let launchpadOutput;
		async function init(load=_ => {}, input=_ => {}) {
			try {
				midiAccess = await navigator.requestMIDIAccess({ sysex: true });
				for (let entry of midiAccess.inputs.values()) {
					if (entry.name.includes("Launchpad")) {
						launchpadInput = entry;
					}
				}
				for (let entry of midiAccess.outputs.values()) {
					if (entry.name.includes("Launchpad")) {
						launchpadOutput = entry;
					}
				}
				if (!launchpadInput || !launchpadOutput) {
					alert('Launchpad not found!')
					console.error('Launchpad not found!');
					return;
				}

				launchpadInput.onmidimessage = msg => {
					const [status, note, velocity] = msg.data;
					input(note, velocity);
				};

				load(launchpadInput, launchpadOutput);

			} catch (err) {
				console.error("Failed to get MIDI access:", err);
			}
		}

		/////

		// function hueToRGB(h) {
		// 	const f = n => {
		// 		const k = (n + h / 30) % 12;
		// 		return Math.round(127 * Math.max(0, Math.min(k, 4 - k, 1)));
		// 	};
		// 	return [f(0), f(8), f(4)];
		// }

		function hueToRGB(hue) {
			let c = 127;
			let x = (1 - Math.abs((hue / 60) % 2 - 1)) * 127;
			let r = 0, g = 0, b = 0;

			if (hue >= 0 && hue < 60)      [r, g, b] = [c, x, 0];
			else if (hue >= 60 && hue < 120)  [r, g, b] = [x, c, 0];
			else if (hue >= 120 && hue < 180) [r, g, b] = [0, c, x];
			else if (hue >= 180 && hue < 240) [r, g, b] = [0, x, c];
			else if (hue >= 240 && hue < 300) [r, g, b] = [x, 0, c];
			else if (hue >= 300 && hue < 360) [r, g, b] = [c, 0, x];

			return [r, g, b].map(Math.floor);
		}

		let iconHue = 0;
		function loopHue() {
			iconHue += 2;
			iconHue = iconHue % 360;
			setLEDs(launchpadOutput, [[99, 3, ...hueToRGB(iconHue)]]);
		}

		/////

		const padEle = document.getElementById('controller').querySelectorAll('.pad');
		// const pads = Object.fromEntries(Array.from({ length: 64 }, (_, j) => [(8 - (j>>3)) * 10 + (j & 7) + 1, null]));

		const pads = Object.fromEntries(Array.from(padEle).map(e => [parseInt(e.id.slice(3)), null]));

		const samples = {};
		async function start() {
			document.getElementById('load').hidden = true;
			samples.amen = await loadAudio('amen.mp3');

			pads[71] = ['', 1.771, 2.019, [true, 5, '#ff6161']];
			pads[72] = ['', 4.312, 4.425, [true, 42, '#61a1dd']];
			pads[73] = ['', 6.347, 6.613, [true, 13, '#ffff61']];
			pads[81] = ['', 0.041, 0.484, [true, 49, '#a161ff']];
			pads[82] = ['', 2.250, 2.450, [true, 25, '#61ff8c']];
			pads[83] = ['', 2.450, 2.893, [true, 53, '#ff61ff']];

			updatePads();

			init(_ => {
				updatePads();
				setInterval(loopHue, 100);
			}, handleInput);
		}

		function updatePads() {
			let specs = [];
			for (const [p, v] of Object.entries(pads)) {
				if (v) {
					const pad = document.getElementById(`pad${p}`);
					pad.style.setProperty('--clr', v[3][2]);

					if (launchpadOutput) {
						specs.push([p, v[3][0] ? 0 : 3, ...(v[3][0] ? [v[3][1]] : v[3][1])]);
					}
				} else if (launchpadOutput) {
					specs.push([p, 0, DEFAULTS.off]);
				}
			}
			if (specs.length !== 0) {
				setLEDs(launchpadOutput, specs);
			}
		}

		const padColour = document.getElementById('pad-clr');
		const chosenColour = document.getElementById('chosen');
		function setPresetColour(e) {
			padColour.dataset.id = e.dataset.value;
			padColour.dataset.rgb = '';
			chosenColour.style.setProperty('--clr', window.getComputedStyle(e).getPropertyValue('--clr'));
		}
		function setRGBColour() {
			const rgb = [...'rgb'].map(i => document.getElementById(`clr-${i}`).value);

			padColour.dataset.id = '';
			padColour.dataset.rgb = `${rgb[0]},${rgb[1]},${rgb[2]}`;
			chosenColour.style.setProperty('--clr', `rgb(${rgb[0]}, ${rgb[1]}, ${rgb[2]})`);
		}
		document.getElementById('presets').querySelectorAll('.colour').forEach(e => {
			e.onclick = () => setPresetColour(e);
		});
		
		const editPadModal = document.getElementById('edit-pad-modal');
		editPadModal.addEventListener('click', e => {
			if (e.target == editPadModal) editPadModal.close();
		});
		function editPad(padId) {
			const pad = pads[padId] ?? null;
			const parent = document.getElementById('waveform');
			parent.innerHTML = '';
			const regions = WaveSurfer.Regions.create();
			const ws = WaveSurfer.create({
				container: parent,
				waveColor: '#aaa',
				progressColor: '#fff',
				normalize: true,
				url: '/amen.mp3',
				plugins: [regions],
			});
			const zoomSlider = document.getElementById('zoom-slider');
			zoomSlider.value = 0;

			ws.on('decode', () => {
				const clip = pad === null ? [0, ws.getDuration()] : [pad[1], pad[2]];
				regions.addRegion({
					start: clip[0],
					end: clip[1],
					content: 'Selection',
					color: '#60f5',
				});
				zoomSlider.addEventListener('input', e => {
					ws.zoom(zoomSlider.valueAsNumber);
					zoomSlider.style.setProperty('--fill', `${zoomSlider.valueAsNumber / parseFloat(zoomSlider.max) * 100}%`)
				});

				parent.dataset.start = clip[0];
				parent.dataset.end = clip[1];
			});

			regions.on('region-clicked', (r, e) => {
				e.stopPropagation();
				ws.play(r.start, r.end);
			});
			regions.on('region-updated', r => {
				parent.dataset.start = r.start;
				parent.dataset.end = r.end;
			});

			//! zoomSlider.value = ws.
			zoomSlider.style.setProperty('--fill', `${zoomSlider.valueAsNumber / parseFloat(zoomSlider.max) * 100}%`)
			
			padColour.dataset.id = '';
			padColour.dataset.rgb = '';
			chosenColour.style.cssText = '';
			if (pad) {
				padColour.dataset.id = pad[3][0] ? pad[3][1] : pad[3][1].join(',');

				if (pad[3][0]) padColour.dataset.id = pad[3][1];
				else padColour.dataset.rgb = pad[3][1].join(',');
				chosenColour.style.setProperty('--clr', pad[3][2]);
			}

			editPadModal.querySelector('.modal').dataset.id = padId;
			editPadModal.showModal();
		}
		function savePad() {
			const padId = parseInt(editPadModal.querySelector('.modal').dataset.id);
			let presetColour = !Number.isNaN(parseInt(padColour.dataset.id));
			let clr;

			if (!padColour.dataset.id && !padColour.dataset.rgb) {
				presetColour = true;
				clr = 0;
			} else if (presetColour) {
				clr = parseInt(padColour.dataset.id);
			} else {
				clr = padColour.dataset.rgb.split(',').map(e => parseInt(e));
			}

			const waveform = document.getElementById('waveform');
			pads[padId] = [
				'/amen.mp3', waveform.dataset.start, waveform.dataset.end,
				[presetColour, clr, window.getComputedStyle(chosenColour).getPropertyValue('--clr')]
			];
			editPadModal.close();

			updatePads();
		}

		const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

		async function loadAudio(url) {
			const resp = await fetch(url);
			const buffer = await resp.arrayBuffer();
			return await audioCtx.decodeAudioData(buffer);
		}
		function playSnippet(buffer, offset = 0, duration = undefined) {
			const src = audioCtx.createBufferSource();
			src.buffer = buffer;
			src.connect(audioCtx.destination);
			src.start(0, offset, duration);
		}
		function playPad(padId) {
			if (!pads[padId]) return;
			playSnippet(samples.amen, pads[padId][1], pads[padId][2]-pads[padId][1]);
		}

		const inputStream = new Set();
		function handleInput(note, vel) {
			const v = pads[note];
			if (vel === 0) {
				inputStream.delete(note);
				setLEDs(launchpadOutput, v ? [[note, v[3][0] ? 0 : 3, ...(v[3][0] ? [v[3][1]] : v[3][1])]] : [[note, 0, DEFAULTS.off]]);
				document.getElementById(`pad${note}`).style.setProperty('--clr', v ? v[3][2] : '');
			} else if (!inputStream.has(note)) {
				inputStream.add(note);
				playPad(note);
				setLEDs(launchpadOutput, v ? [[note, v[4][0] ? 0 : 3, ...(v[4][0] ? [v[4][1]] : v[4][1])]] : [[note, 0, DEFAULTS.on]]);
				document.getElementById(`pad${note}`).style.setProperty('--clr', v ? v[4][2] : DEFAULTS._on);
			}
		}

		padEle.forEach(e => {
			e.onclick = () => playPad(e.id.slice(3));
			e.ondblclick = () => editPad(e.id.slice(3));
		});

		// document.getElementById('load').hidden = true;
		
	</script>

</body>
</html>