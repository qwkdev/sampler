<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Document</title>

	<style>
		body {
			background: #000;
			color: #fff;
		}
	</style>
</head>
<body>
	<h2>Launchpad Mini (MK1) Controller</h2>
	<button id="connect">Connect MIDI</button>
	<script>
		const midiCodes = {
			logo: 99,
			top: Array.from({ length: 8 }, (_, i) => 91+i),
			side: Array.from({ length: 8 }, (_, i) => 89-(i*10)),
			grid: Array.from({ length: 8 }, (_, i) => Array.from({ length: 8 }, (_, j) => 81-(10*i)+j))
		};

		function toPad(note) {
			if (note == 99) return { type: 'logo' }
			if (91 <= note && note <= 98) return { type: 'top', pos: note - 91 }
			if ((note - 9) % 10 == 0) return { type: 'side', pos: (89-note)/10 }
			return { type: 'grid', x: (note % 10) - 1, y: 8 - Math.floor(note/10) }
		}

		function setLEDs(lOut, spec) {
			if (spec.length == 1 && spec[0][1] !== 3) {
				lOut.send([144, spec[0][0], spec[0][2]]);
				return;
			}
			if (spec.length > 81) throw Error('Max 81 colourspecs at a time');

			let data = [];
			spec.forEach(info => {
				data.push(
					info[1],
					info[0],
					...(info[1] === 3 ? [info[2], info[3], info[4]] : [info[2]])
				);
			})
			lOut.send([240, 0, 32, 41, 2, 12, 3, ...data, 247]);
		}
		function setAllLEDs(lOut, spec) {
			setLEDs(lOut, Array.from({ length: 81 }, (_, i) => [
				Math.floor(i / 9) * 10 + 11 + (i % 9), ...spec
			]));
		}

		function sendText(lOut, text, palatte=null, rgb=null, speed=12, loop=false) {
			let textData = [];
			Array.from(text).forEach(c => {
				const ascii = c.charCodeAt();
				if (ascii < 128) textData.push(ascii);
				else throw Error('Invalid non-ascii character.');
			});

			lOut.send([
				240, 0, 32, 41, 2, 12, 7,
				loop ? 1 : 0,
				speed,
				palatte !== null ? 0 : 1,
				...(palatte !== null ? [palatte] : [rgb[0], rgb[1], rgb[2]]),
				...textData,
				247
			])
		}
		function stopText(lOut) {
			lOut.send([240, 0, 32, 41, 2, 12, 7, 247]);
		}

		async function init(load=_ => {}, input=_ => {}) {
			try {
				midiAccess = await navigator.requestMIDIAccess({ sysex: true });
				for (let entry of midiAccess.inputs.values()) {
					if (entry.name.includes("Launchpad")) {
						launchpadInput = entry;
					}
				}
				for (let entry of midiAccess.outputs.values()) {
					if (entry.name.includes("Launchpad")) {
						launchpadOutput = entry;
					}
				}
				if (!launchpadInput || !launchpadOutput) {
					alert('Launchpad not found!')
					console.error('Launchpad not found!');
					return;
				}

				launchpadInput.onmidimessage = msg => {
					const [status, note, velocity] = msg.data;
					input(toPad(note), velocity);
				};

				load(launchpadInput, launchpadOutput);

			} catch (err) {
				console.error("Failed to get MIDI access:", err);
			}
		}

		function update(lOut) {
			setLEDs(lOut, Array.from({ length: 64 }, (_, i) => [
				midiCodes.grid[Math.floor(i/8)][i % 8],
				0,
				Math.floor(Math.random() * 127)+1
			]));
		}

		init((lIn, lOut) => {
			// setLEDs(lOut, [
			// 	[98, 0, 5],
			// ]);
			// sendText(lOut, '', 49, null, 16, 1);

			setAllLEDs(lOut, [0, 0]);
			setInterval(() => update(lOut), 100);
		}, (pad, vel) => {
			console.log(pad, vel);
		});
	</script>
</body>
</html>